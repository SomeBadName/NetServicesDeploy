name: Deploy Docker Service (reusable)

on:
  workflow_call:
    inputs:
      environment_name:
        type: string
        required: true

      service_name:
        type: string
        required: true

      host_port:
        type: string
        required: true

      container_port:
        type: string
        required: false
        default: "8080"

      stack_dir:
        type: string
        required: false
        default: ""

      dockerfile_path:
        type: string
        required: false
        default: "./Dockerfile"

      health_path:
        type: string
        required: false
        default: "/health"

      env_vars:
        type: string
        required: false
        default: ""

      # Template lines that can reference $S1..$S5
      env_secrets:
        type: string
        required: false
        default: ""

      # Names of secrets stored in the caller repo Environment (inputs.environment_name)
      secret1_name:
        type: string
        required: false
        default: ""
      secret2_name:
        type: string
        required: false
        default: ""
      secret3_name:
        type: string
        required: false
        default: ""
      secret4_name:
        type: string
        required: false
        default: ""
      secret5_name:
        type: string
        required: false
        default: ""

permissions:
  contents: read
  packages: write

jobs:
  build_and_deploy:
    runs-on: [self-hosted]
    environment: ${{ inputs.environment_name }}

    steps:
      - name: Checkout service repo
        uses: actions/checkout@v4

      - name: Compute vars
        shell: bash
        run: |
          OWNER_LC="$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')"
          SERVICE="${{ inputs.service_name }}"

          echo "SERVICE=$SERVICE" >> $GITHUB_ENV
          echo "OWNER_LC=$OWNER_LC" >> $GITHUB_ENV
          echo "IMAGE=ghcr.io/${OWNER_LC}/${SERVICE}:latest" >> $GITHUB_ENV

          if [[ -n "${{ inputs.stack_dir }}" ]]; then
            echo "STACK_DIR=${{ inputs.stack_dir }}" >> $GITHUB_ENV
          else
            echo "STACK_DIR=/opt/stacks/${SERVICE}" >> $GITHUB_ENV
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile_path }}
          push: true
          tags: |
            ${{ env.IMAGE }}
            ghcr.io/${{ env.OWNER_LC }}/${{ env.SERVICE }}:${{ github.sha }}

      - name: Ensure stack folder (no sudo)
        run: |
          mkdir -p "${STACK_DIR}"

      - name: Write stack .env (vars + secret template)
        shell: bash
        env:
          # Resolve secrets from the caller repo Environment by name (optional)
          S1: ${{ inputs.secret1_name != '' && secrets[inputs.secret1_name] || '' }}
          S2: ${{ inputs.secret2_name != '' && secrets[inputs.secret2_name] || '' }}
          S3: ${{ inputs.secret3_name != '' && secrets[inputs.secret3_name] || '' }}
          S4: ${{ inputs.secret4_name != '' && secrets[inputs.secret4_name] || '' }}
          S5: ${{ inputs.secret5_name != '' && secrets[inputs.secret5_name] || '' }}
        run: |
          {
            echo "IMAGE=${IMAGE}"
            echo "HOST_PORT=${{ inputs.host_port }}"
            echo "CONTAINER_PORT=${{ inputs.container_port }}"

            # Plain vars
            if [[ -n "${{ inputs.env_vars }}" ]]; then
              printf '%s\n' "${{ inputs.env_vars }}"
            fi

            # Secret lines template (supports $S1..$S5 placeholders)
            if [[ -n "${{ inputs.env_secrets }}" ]]; then
              while IFS= read -r line; do
                [[ -z "$line" ]] && continue
                eval "echo \"$line\""
              done <<< "${{ inputs.env_secrets }}"
            fi
          } > "${STACK_DIR}/.env"
          chmod 600 "${STACK_DIR}/.env"

      - name: Render docker-compose.yml (from template)
        shell: bash
        run: |
          cat > "${STACK_DIR}/docker-compose.yml" <<YML
          services:
            ${SERVICE}:
              image: ${IMAGE}
              container_name: ${SERVICE}
              ports:
                - "${{ inputs.host_port }}:${{ inputs.container_port }}"
              env_file:
                - .env
              environment:
                ASPNETCORE_URLS: http://0.0.0.0:${{ inputs.container_port }}
              restart: unless-stopped
          YML

      - name: Deploy (pull + up)
        run: |
          cd "${STACK_DIR}"
          docker compose pull
          docker compose up -d
          docker ps --filter "name=${SERVICE}"

      - name: Health check
        shell: bash
        run: |
          URL="http://127.0.0.1:${{ inputs.host_port }}${{ inputs.health_path }}"
          echo "Checking $URL"
          for i in {1..60}; do
            if curl -fsS --max-time 2 "$URL" >/dev/null; then
              echo "OK"
              exit 0
            fi
            sleep 1
          done
          echo "Healthcheck failed" >&2
          exit 1
